# ğŸ”— ì‹œìŠ¤í…œ í†µí•© ê°€ì´ë“œ - v2.0 + ì¹´ì¹´ì˜¤í†¡ ì—°ê³„

## ğŸ¯ ê°œìš”

**v2.0 íŒë§¤ ì‹œìŠ¤í…œ**ê³¼ **ì¹´ì¹´ì˜¤í†¡ ì±„ë„**ì„ ì™„ì „íˆ í†µí•©í•˜ì—¬ ìë™í™”ëœ CRM ì‹œìŠ¤í…œì„ êµ¬ì¶•í•©ë‹ˆë‹¤.

### í†µí•©ë˜ëŠ” ì‹œìŠ¤í…œ
1. **v2.0 íŒë§¤ ì‹œìŠ¤í…œ**
   - Google Sheets ë°ì´í„°ë² ì´ìŠ¤
   - JWT ë³´ì•ˆ ë‹¤ìš´ë¡œë“œ
   - ìë™ í™˜ë¶ˆ ì²˜ë¦¬
   - ì¼ì¼ ë¶„ì„ ë¦¬í¬íŠ¸

2. **ì¹´ì¹´ì˜¤í†¡ ì±„ë„ ì‹œìŠ¤í…œ**
   - ì•Œë¦¼í†¡ ìë™ ë°œì†¡
   - ë‹¤ìš´ë¡œë“œ ë§í¬ ì¬ë°œê¸‰
   - ì±—ë´‡ ìë™ ì‘ë‹µ

---

## ğŸ“Š í†µí•© ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ì‚¬ìš©ì                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
         â”‚                                                 â”‚
         â–¼                                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ì›¹ ê²°ì œ í˜ì´ì§€  â”‚                              â”‚  ì¹´ì¹´ì˜¤í†¡ ì±„ë„    â”‚
â”‚  (landing.html) â”‚                              â”‚   (ê³ ê° ë¬¸ì˜)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                                 â”‚
         â–¼                                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Vercel Serverless Functions               â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ confirm-     â”‚  â”‚  refund/     â”‚  â”‚ renew-download-   â”‚ â”‚
â”‚  â”‚ payment.js   â”‚  â”‚  process.js  â”‚  â”‚ link.js           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                 â”‚                     â”‚           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                           â”‚                                 â”‚
â”‚                           â–¼                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚      lib/sheets.js (DB í—¬í¼)        â”‚             â”‚
â”‚         â”‚      lib/jwt.js (ë³´ì•ˆ)              â”‚             â”‚
â”‚         â”‚      lib/kakao-alimtalk.js (ì•Œë¦¼í†¡) â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                â”‚                â”‚
         â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Google      â”‚  â”‚  Gmail      â”‚  â”‚  Solapi         â”‚
â”‚ Sheets DB   â”‚  â”‚  SMTP       â”‚  â”‚  (ì•Œë¦¼í†¡)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚                â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ì‚¬ìš©ì   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ í†µí•© ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ê²°ì œ ì™„ë£Œ (ì´ë©”ì¼ + ì•Œë¦¼í†¡)

**íë¦„:**
```
1. ì‚¬ìš©ì ê²°ì œ ì™„ë£Œ
   â†“
2. confirm-payment.js ì‹¤í–‰
   â†“
3. í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ ìŠ¹ì¸
   â†“
4. JWT ë‹¤ìš´ë¡œë“œ í† í° ìƒì„±
   â†“
5. Google Sheetsì— ì£¼ë¬¸ ì €ì¥ (íœ´ëŒ€í° ë²ˆí˜¸ í¬í•¨)
   â†“
6. Gmailë¡œ ì´ë©”ì¼ ë°œì†¡ (ë³´ì•ˆ ë§í¬ í¬í•¨)
   â†“
7. ì•Œë¦¼í†¡ ë°œì†¡ (íœ´ëŒ€í° ë²ˆí˜¸ ìˆëŠ” ê²½ìš°)
   â†“
8. ì‚¬ìš©ìì—ê²Œ ì´ë©”ì¼ + ì¹´í†¡ ë„ì°©
```

**ë°ì´í„° íë¦„:**
```javascript
// í† ìŠ¤í˜ì´ë¨¼ì¸  ì‘ë‹µ
{
  orderId: "ORDER_20251004_XXXXX",
  customerEmail: "user@example.com",
  customerMobilePhone: "01012345678",  // â† ì¤‘ìš”!
  amount: 9990
}
   â†“
// Google Sheets ì €ì¥
{
  orderId: "ORDER_20251004_XXXXX",
  customerEmail: "user@example.com",
  customerPhone: "01012345678",        // â† DB ì €ì¥
  amount: 9990,
  downloadToken: "eyJhbGc..."
}
   â†“
// ì´ë©”ì¼ ë°œì†¡
To: user@example.com
Subject: ğŸ‰ êµ¬ë§¤ ì™„ë£Œ!
Body: ë‹¤ìš´ë¡œë“œ ë§í¬: https://domain.com/api/download/TOKEN
   â†“
// ì•Œë¦¼í†¡ ë°œì†¡ (if customerPhone exists)
To: 01012345678
Template: TEMPLATE_001
Message: [Claude ì™„ë²½ ê°€ì´ë“œ] êµ¬ë§¤ ê°ì‚¬...
Button: [ë‹¤ìš´ë¡œë“œí•˜ê¸°]
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: í™˜ë¶ˆ ìš”ì²­ (ì´ë©”ì¼ + ì•Œë¦¼í†¡)

**íë¦„:**
```
1. ì‚¬ìš©ìê°€ ì¹´ì¹´ì˜¤í†¡ ì±„ë„ë¡œ í™˜ë¶ˆ ìš”ì²­
   â†“
2. ê´€ë¦¬ìê°€ ì£¼ë¬¸ë²ˆí˜¸ í™•ì¸
   â†“
3. refund/process.js API í˜¸ì¶œ
   â†“
4. Google Sheetsì—ì„œ ì£¼ë¬¸ ì¡°íšŒ
   â†“
5. 7ì¼ ì´ë‚´ í™•ì¸
   â†“
6. í† ìŠ¤í˜ì´ë¨¼ì¸  í™˜ë¶ˆ ìš”ì²­
   â†“
7. Google Sheets ìƒíƒœ ì—…ë°ì´íŠ¸ (REFUNDED)
   â†“
8. Gmailë¡œ í™˜ë¶ˆ ì™„ë£Œ ì´ë©”ì¼ ë°œì†¡
   â†“
9. ì•Œë¦¼í†¡ í™˜ë¶ˆ ì™„ë£Œ ë°œì†¡
   â†“
10. ì‚¬ìš©ìì—ê²Œ ì´ë©”ì¼ + ì¹´í†¡ ë„ì°©
```

### ì‹œë‚˜ë¦¬ì˜¤ 3: ë‹¤ìš´ë¡œë“œ ë§í¬ ì¬ë°œê¸‰

**íë¦„:**
```
1. ì‚¬ìš©ì: ì¹´ì¹´ì˜¤í†¡ ì±„ë„ë¡œ "ë§í¬ê°€ ì•ˆ ì—´ë ¤ìš”" ë¬¸ì˜
   â†“
2. ì±—ë´‡: "ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"
   â†“
3. ì‚¬ìš©ì: "ORDER_20251004_XXXXX"
   â†“
4. ê´€ë¦¬ì ë˜ëŠ” ìë™í™”: renew-download-link.js API í˜¸ì¶œ
   â†“
5. Google Sheetsì—ì„œ ì£¼ë¬¸ ì¡°íšŒ
   â†“
6. ë‹¤ìš´ë¡œë“œ íšŸìˆ˜ í™•ì¸ (5íšŒ ë¯¸ë§Œ)
   â†“
7. ìƒˆ JWT í† í° ìƒì„±
   â†“
8. Google Sheets ì—…ë°ì´íŠ¸ (ìƒˆ í† í°)
   â†“
9. Gmailë¡œ ìƒˆ ë§í¬ ë°œì†¡
   â†“
10. ì•Œë¦¼í†¡ìœ¼ë¡œ ìƒˆ ë§í¬ ë°œì†¡
   â†“
11. ì‚¬ìš©ìì—ê²Œ ì´ë©”ì¼ + ì¹´í†¡ ë„ì°©
```

---

## ğŸ’¾ Google Sheets ìŠ¤í‚¤ë§ˆ í™•ì¥

### Orders ì‹œíŠ¸ (ê¸°ì¡´ + ì¶”ê°€)

**ê¸°ì¡´ í•„ë“œ:**
- orderId
- paymentKey
- amount
- customerEmail
- customerName
- status
- createdAt
- paidAt
- refundedAt
- downloadToken

**ì¶”ê°€ í•„ë“œ:** â­
- **customerPhone** (íœ´ëŒ€í° ë²ˆí˜¸)
- **alimtalkSent** (ì•Œë¦¼í†¡ ë°œì†¡ ì—¬ë¶€)
- **alimtalkMessageId** (ì•Œë¦¼í†¡ ë©”ì‹œì§€ ID)

**ì „ì²´ ìŠ¤í‚¤ë§ˆ:**
```
A: orderId
B: paymentKey
C: amount
D: customerEmail
E: customerName
F: customerPhone          â† ì‹ ê·œ
G: status
H: createdAt
I: paidAt
J: refundedAt
K: downloadToken
L: alimtalkSent           â† ì‹ ê·œ
M: alimtalkMessageId      â† ì‹ ê·œ
```

---

## ğŸ”§ ì½”ë“œ í†µí•©

### 1. Google Sheets í—¬í¼ ìˆ˜ì •

**íŒŒì¼:** `api/lib/sheets.js` (ìˆ˜ì •)

```javascript
/**
 * ì£¼ë¬¸ ì •ë³´ ì €ì¥ - íœ´ëŒ€í° ë²ˆí˜¸ ì¶”ê°€
 */
export async function saveOrder(orderData) {
    const sheets = await getSheetsClient();
    const spreadsheetId = process.env.SPREADSHEET_ID;

    const values = [[
        orderData.orderId,
        orderData.paymentKey,
        orderData.amount,
        orderData.customerEmail,
        orderData.customerName || '',
        orderData.customerPhone || '',           // â† ì¶”ê°€
        orderData.status || 'PAID',
        new Date().toISOString(),
        orderData.paidAt || new Date().toISOString(),
        orderData.refundedAt || '',
        orderData.downloadToken || '',
        orderData.alimtalkSent || false,        // â† ì¶”ê°€
        orderData.alimtalkMessageId || ''       // â† ì¶”ê°€
    ]];

    try {
        const response = await sheets.spreadsheets.values.append({
            spreadsheetId,
            range: 'Orders!A:M',  // Jì—ì„œ Mìœ¼ë¡œ í™•ì¥
            valueInputOption: 'USER_ENTERED',
            resource: { values }
        });

        return { success: true, data: response.data };
    } catch (error) {
        console.error('ì£¼ë¬¸ ì €ì¥ ì‹¤íŒ¨:', error);
        throw new Error('ì£¼ë¬¸ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

/**
 * ì£¼ë¬¸ ì¡°íšŒ - íœ´ëŒ€í° ë²ˆí˜¸ í¬í•¨
 */
export async function getOrder(orderId) {
    const sheets = await getSheetsClient();
    const spreadsheetId = process.env.SPREADSHEET_ID;

    try {
        const response = await sheets.spreadsheets.values.get({
            spreadsheetId,
            range: 'Orders!A:M'  // í™•ì¥ëœ ë²”ìœ„
        });

        const rows = response.data.values;
        if (!rows || rows.length <= 1) {
            return null;
        }

        for (let i = 1; i < rows.length; i++) {
            if (rows[i][0] === orderId) {
                return {
                    rowIndex: i + 1,
                    orderId: rows[i][0],
                    paymentKey: rows[i][1],
                    amount: parseInt(rows[i][2]),
                    customerEmail: rows[i][3],
                    customerName: rows[i][4],
                    customerPhone: rows[i][5],        // â† ì¶”ê°€
                    status: rows[i][6],
                    createdAt: rows[i][7],
                    paidAt: rows[i][8],
                    refundedAt: rows[i][9],
                    downloadToken: rows[i][10],
                    alimtalkSent: rows[i][11] === 'true',  // â† ì¶”ê°€
                    alimtalkMessageId: rows[i][12]    // â† ì¶”ê°€
                };
            }
        }

        return null;
    } catch (error) {
        console.error('ì£¼ë¬¸ ì¡°íšŒ ì‹¤íŒ¨:', error);
        throw new Error('ì£¼ë¬¸ ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

/**
 * ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì´ˆê¸°í™” - í—¤ë” í™•ì¥
 */
export async function initializeSpreadsheet() {
    const sheets = await getSheetsClient();
    const spreadsheetId = process.env.SPREADSHEET_ID;

    try {
        // Orders ì‹œíŠ¸ í—¤ë” - í™•ì¥
        await sheets.spreadsheets.values.update({
            spreadsheetId,
            range: 'Orders!A1:M1',  // J1ì—ì„œ M1ë¡œ í™•ì¥
            valueInputOption: 'USER_ENTERED',
            resource: {
                values: [[
                    'orderId', 'paymentKey', 'amount', 'customerEmail', 'customerName',
                    'customerPhone', 'status', 'createdAt', 'paidAt', 'refundedAt',
                    'downloadToken', 'alimtalkSent', 'alimtalkMessageId'
                ]]
            }
        });

        // DownloadLogs, Analytics ì‹œíŠ¸ëŠ” ë™ì¼
        // ...

        return { success: true, message: 'ìŠ¤í”„ë ˆë“œì‹œíŠ¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.' };
    } catch (error) {
        console.error('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        throw new Error('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ì´ˆê¸°í™”í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}
```

### 2. confirm-payment.js í†µí•©

**íŒŒì¼:** `api/confirm-payment.js` (ìˆ˜ì •)

```javascript
import nodemailer from 'nodemailer';
import { saveOrder, getOrder } from './lib/sheets.js';
import { generateDownloadToken } from './lib/jwt.js';
import { sendPaymentConfirmation } from './lib/kakao-alimtalk.js';  // â† ì¶”ê°€

export default async function handler(req, res) {
    if (req.method !== 'POST') {
        return res.status(405).json({ message: 'Method not allowed' });
    }

    const { paymentKey, orderId, amount } = req.body;

    try {
        // 1. ì¤‘ë³µ ì£¼ë¬¸ í™•ì¸
        const existingOrder = await getOrder(orderId);
        if (existingOrder) {
            return res.status(200).json({
                success: true,
                email: existingOrder.customerEmail,
                orderId: orderId,
                message: 'ì´ë¯¸ ì²˜ë¦¬ëœ ì£¼ë¬¸ì…ë‹ˆë‹¤.'
            });
        }

        // 2. í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ ìŠ¹ì¸
        const response = await fetch('https://api.tosspayments.com/v1/payments/confirm', {
            method: 'POST',
            headers: {
                'Authorization': 'Basic ' + Buffer.from(process.env.TOSS_SECRET_KEY + ':').toString('base64'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ paymentKey, orderId, amount })
        });

        const payment = await response.json();

        if (!response.ok) {
            throw new Error(payment.message || 'ê²°ì œ ìŠ¹ì¸ ì‹¤íŒ¨');
        }

        // 3. ë³´ì•ˆ ë‹¤ìš´ë¡œë“œ í† í° ìƒì„±
        const downloadToken = generateDownloadToken({
            orderId: orderId,
            customerEmail: payment.customerEmail
        });

        // 4. Google Sheetsì— ì£¼ë¬¸ ì •ë³´ ì €ì¥ (íœ´ëŒ€í° ë²ˆí˜¸ í¬í•¨)
        const orderData = {
            orderId: orderId,
            paymentKey: paymentKey,
            amount: amount,
            customerEmail: payment.customerEmail,
            customerName: payment.customerName || '',
            customerPhone: payment.customerMobilePhone || '',  // â† í† ìŠ¤ì—ì„œ ë°›ì€ íœ´ëŒ€í° ë²ˆí˜¸
            status: 'PAID',
            paidAt: payment.approvedAt || new Date().toISOString(),
            downloadToken: downloadToken
        };

        await saveOrder(orderData);

        // 5. ë³´ì•ˆ ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
        const baseUrl = process.env.BASE_URL || 'https://your-domain.vercel.app';
        const secureDownloadLink = `${baseUrl}/api/download/${downloadToken}`;

        // 6. ì´ë©”ì¼ ë°œì†¡
        const transporter = nodemailer.createTransport({
            service: 'gmail',
            auth: {
                user: process.env.GMAIL_USER,
                pass: process.env.GMAIL_APP_PASSWORD
            }
        });

        const expiryHours = parseInt(process.env.DOWNLOAD_TOKEN_EXPIRY_HOURS) || 24;
        const maxDownloads = parseInt(process.env.MAX_DOWNLOAD_COUNT) || 5;

        const mailOptions = {
            from: `"Claude ì™„ë²½ ê°€ì´ë“œ" <${process.env.GMAIL_USER}>`,
            to: payment.customerEmail,
            subject: 'ğŸ‰ Claude ì™„ë²½ ê°€ì´ë“œ êµ¬ë§¤ ì™„ë£Œ!',
            html: `
                <!-- ê¸°ì¡´ ì´ë©”ì¼ í…œí”Œë¦¿ -->
            `
        };

        await transporter.sendMail(mailOptions);

        // 7. ì•Œë¦¼í†¡ ë°œì†¡ (íœ´ëŒ€í° ë²ˆí˜¸ê°€ ìˆëŠ” ê²½ìš°) â† ì¶”ê°€
        let alimtalkResult = null;
        if (payment.customerMobilePhone) {
            alimtalkResult = await sendPaymentConfirmation({
                phoneNumber: payment.customerMobilePhone,
                orderId: orderId,
                amount: amount,
                downloadLink: secureDownloadLink
            });

            // ì•Œë¦¼í†¡ ë°œì†¡ ê²°ê³¼ Google Sheets ì—…ë°ì´íŠ¸
            if (alimtalkResult.success) {
                await updateOrder(orderId, {
                    alimtalkSent: true,
                    alimtalkMessageId: alimtalkResult.messageId
                });
            }
        }

        // 8. ì„±ê³µ ì‘ë‹µ
        return res.status(200).json({
            success: true,
            email: payment.customerEmail,
            orderId: orderId,
            downloadToken: downloadToken,
            emailSent: true,
            alimtalkSent: alimtalkResult?.success || false  // â† ì¶”ê°€
        });

    } catch (error) {
        console.error('ê²°ì œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);

        return res.status(500).json({
            success: false,
            message: error.message || 'ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
        });
    }
}
```

### 3. refund/process.js í†µí•©

**íŒŒì¼:** `api/refund/process.js` (ìˆ˜ì •)

```javascript
import nodemailer from 'nodemailer';
import { getOrder, updateOrder } from '../lib/sheets.js';
import { sendRefundConfirmation } from '../lib/kakao-alimtalk.js';  // â† ì¶”ê°€

export default async function handler(req, res) {
    if (req.method !== 'POST') {
        return res.status(405).json({ error: 'í—ˆìš©ë˜ì§€ ì•Šì€ ë©”ì„œë“œì…ë‹ˆë‹¤.' });
    }

    const { orderId, cancelReason } = req.body;

    if (!orderId) {
        return res.status(400).json({
            success: false,
            error: 'ì£¼ë¬¸ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
        });
    }

    try {
        // 1-3. ì£¼ë¬¸ í™•ì¸, í™˜ë¶ˆ ì—¬ë¶€, ê¸°ê°„ í™•ì¸ (ê¸°ì¡´ ì½”ë“œ)
        const order = await getOrder(orderId);
        if (!order) {
            return res.status(404).json({
                success: false,
                error: 'ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
            });
        }

        if (order.status === 'REFUNDED') {
            return res.status(400).json({
                success: false,
                error: 'ì´ë¯¸ í™˜ë¶ˆëœ ì£¼ë¬¸ì…ë‹ˆë‹¤.'
            });
        }

        const paidDate = new Date(order.paidAt);
        const now = new Date();
        const daysSincePurchase = Math.floor((now - paidDate) / (1000 * 60 * 60 * 24));

        if (daysSincePurchase > 7) {
            return res.status(400).json({
                success: false,
                error: 'í™˜ë¶ˆ ê°€ëŠ¥ ê¸°ê°„(7ì¼)ì´ ì§€ë‚¬ìŠµë‹ˆë‹¤.',
                daysSincePurchase: daysSincePurchase
            });
        }

        // 4. í† ìŠ¤í˜ì´ë¨¼ì¸  í™˜ë¶ˆ ìš”ì²­ (ê¸°ì¡´ ì½”ë“œ)
        const refundResponse = await fetch(
            `https://api.tosspayments.com/v1/payments/${order.paymentKey}/cancel`,
            {
                method: 'POST',
                headers: {
                    'Authorization': 'Basic ' + Buffer.from(process.env.TOSS_SECRET_KEY + ':').toString('base64'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    cancelReason: cancelReason || 'ê³ ê° ìš”ì²­'
                })
            }
        );

        const refundResult = await refundResponse.json();

        if (!refundResponse.ok) {
            throw new Error(refundResult.message || 'í™˜ë¶ˆ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

        // 5. ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸
        await updateOrder(orderId, {
            status: 'REFUNDED',
            refundedAt: new Date().toISOString()
        });

        // 6. í™˜ë¶ˆ ì™„ë£Œ ì´ë©”ì¼ ë°œì†¡ (ê¸°ì¡´ ì½”ë“œ)
        const transporter = nodemailer.createTransport({
            service: 'gmail',
            auth: {
                user: process.env.GMAIL_USER,
                pass: process.env.GMAIL_APP_PASSWORD
            }
        });

        const mailOptions = {
            from: `"Claude ì™„ë²½ ê°€ì´ë“œ" <${process.env.GMAIL_USER}>`,
            to: order.customerEmail,
            subject: 'âœ… í™˜ë¶ˆ ì²˜ë¦¬ ì™„ë£Œ ì•ˆë‚´',
            html: `
                <!-- ê¸°ì¡´ ì´ë©”ì¼ í…œí”Œë¦¿ -->
            `
        };

        await transporter.sendMail(mailOptions);

        // 7. ì•Œë¦¼í†¡ ë°œì†¡ (íœ´ëŒ€í° ë²ˆí˜¸ê°€ ìˆëŠ” ê²½ìš°) â† ì¶”ê°€
        let alimtalkResult = null;
        if (order.customerPhone) {
            alimtalkResult = await sendRefundConfirmation({
                phoneNumber: order.customerPhone,
                orderId: orderId,
                amount: order.amount,
                refundDate: new Date().toLocaleString('ko-KR')
            });
        }

        // 8. ì„±ê³µ ì‘ë‹µ
        return res.status(200).json({
            success: true,
            message: 'í™˜ë¶ˆì´ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.',
            orderId: orderId,
            refundAmount: order.amount,
            refundedAt: new Date().toISOString(),
            emailSent: true,
            alimtalkSent: alimtalkResult?.success || false  // â† ì¶”ê°€
        });

    } catch (error) {
        console.error('í™˜ë¶ˆ ì²˜ë¦¬ ì˜¤ë¥˜:', error);

        return res.status(500).json({
            success: false,
            error: error.message || 'í™˜ë¶ˆ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
        });
    }
}
```

---

## ğŸ§ª í†µí•© í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

### 1. ê²°ì œ ì™„ë£Œ í…ŒìŠ¤íŠ¸

**1ë‹¨ê³„: í™˜ê²½ë³€ìˆ˜ í™•ì¸**
```env
# .env íŒŒì¼
SOLAPI_API_KEY=ì‹¤ì œ_í‚¤
SOLAPI_API_SECRET=ì‹¤ì œ_ì‹œí¬ë¦¿
KAKAO_PFID=ì‹¤ì œ_ì±„ë„_ID
KAKAO_TEMPLATE_PAYMENT=ìŠ¹ì¸ë°›ì€_í…œí”Œë¦¿_ID
```

**2ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ê²°ì œ ì§„í–‰**
1. ëœë”© í˜ì´ì§€ ì ‘ì†
2. "êµ¬ë§¤í•˜ê¸°" í´ë¦­
3. í…ŒìŠ¤íŠ¸ ì¹´ë“œ ì…ë ¥
   - ì¹´ë“œë²ˆí˜¸: 4242424242424242
   - íœ´ëŒ€í°: 01012345678 ì…ë ¥ â† ì¤‘ìš”!

**3ë‹¨ê³„: ê²°ê³¼ í™•ì¸**
- âœ… ì´ë©”ì¼ ìˆ˜ì‹  (Gmail)
- âœ… ì•Œë¦¼í†¡ ìˆ˜ì‹  (íœ´ëŒ€í°)
- âœ… Google Sheets Orders ì‹œíŠ¸ì— ë°ì´í„° ì €ì¥
  - customerPhone: 01012345678
  - alimtalkSent: true
  - alimtalkMessageId: SOLAPI_MESSAGE_ID

### 2. í™˜ë¶ˆ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸

**API í˜¸ì¶œ:**
```bash
curl -X POST https://your-domain.vercel.app/api/refund/process \
  -H "Content-Type: application/json" \
  -d '{
    "orderId": "í…ŒìŠ¤íŠ¸_ì£¼ë¬¸ë²ˆí˜¸",
    "cancelReason": "í…ŒìŠ¤íŠ¸ í™˜ë¶ˆ"
  }'
```

**ê²°ê³¼ í™•ì¸:**
- âœ… ì´ë©”ì¼ ìˆ˜ì‹ 
- âœ… ì•Œë¦¼í†¡ ìˆ˜ì‹ 
- âœ… Google Sheets ìƒíƒœ: REFUNDED

### 3. ë§í¬ ì¬ë°œê¸‰ í…ŒìŠ¤íŠ¸

**API í˜¸ì¶œ:**
```bash
curl -X POST https://your-domain.vercel.app/api/renew-download-link \
  -H "Content-Type: application/json" \
  -d '{"orderId": "í…ŒìŠ¤íŠ¸_ì£¼ë¬¸ë²ˆí˜¸"}'
```

**ê²°ê³¼ í™•ì¸:**
- âœ… ìƒˆ JWT í† í° ìƒì„±
- âœ… ì´ë©”ì¼ ìˆ˜ì‹ 
- âœ… ì•Œë¦¼í†¡ ìˆ˜ì‹ 
- âœ… Google Sheets downloadToken ì—…ë°ì´íŠ¸

---

## ğŸ“± ì¹´ì¹´ì˜¤í†¡ ì±„ë„ ì‹œë‚˜ë¦¬ì˜¤ í†µí•©

### ìë™ ì‘ë‹µ ì„¤ì • (ì±„ë„ ê´€ë¦¬ìì„¼í„°)

**ì²« ì±„íŒ… ë©”ì‹œì§€:**
```
ì•ˆë…•í•˜ì„¸ìš”! Claude ì™„ë²½ ê°€ì´ë“œì…ë‹ˆë‹¤ ğŸ¤–

ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?

1ï¸âƒ£ ë‹¤ìš´ë¡œë“œ ë§í¬ ë¬¸ì œ
2ï¸âƒ£ í™˜ë¶ˆ ë¬¸ì˜
3ï¸âƒ£ ì—…ë°ì´íŠ¸ ë¬¸ì˜
4ï¸âƒ£ ê¸°íƒ€ ë¬¸ì˜

ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!
```

**"1" ì…ë ¥ ì‹œ:**
```
ë‹¤ìš´ë¡œë“œ ë§í¬ ì¬ë°œê¸‰ì„ ë„ì™€ë“œë¦´ê²Œìš”.

ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
(ì˜ˆ: ORDER_20251004_XXXXX)

ì£¼ë¬¸ë²ˆí˜¸ëŠ” êµ¬ë§¤ ì™„ë£Œ ì´ë©”ì¼ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```

**ì£¼ë¬¸ë²ˆí˜¸ ì…ë ¥ ì‹œ (ê´€ë¦¬ì ì²˜ë¦¬):**
1. ì£¼ë¬¸ë²ˆí˜¸ ë³µì‚¬
2. API í˜¸ì¶œ (Postman ë˜ëŠ” curl)
   ```bash
   curl -X POST https://domain.com/api/renew-download-link \
     -d '{"orderId":"ë³µì‚¬í•œ_ì£¼ë¬¸ë²ˆí˜¸"}'
   ```
3. ìë™ìœ¼ë¡œ ê³ ê°ì—ê²Œ ì´ë©”ì¼ + ì•Œë¦¼í†¡ ë°œì†¡
4. ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ì•ˆë‚´
   ```
   âœ… ìƒˆë¡œìš´ ë‹¤ìš´ë¡œë“œ ë§í¬ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!

   ì´ë©”ì¼ê³¼ ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
   (ë³´í†µ 1-2ë¶„ ë‚´ ë„ì°©í•©ë‹ˆë‹¤)
   ```

**"2" ì…ë ¥ ì‹œ (í™˜ë¶ˆ):**
```
í™˜ë¶ˆ ì‹ ì²­ì„ ë„ì™€ë“œë¦´ê²Œìš”.

ğŸ“Œ í™˜ë¶ˆ ê°€ëŠ¥ ê¸°ê°„: êµ¬ë§¤ í›„ 7ì¼ ì´ë‚´
ğŸ“Œ í™˜ë¶ˆ ë°©ë²•: ì „ì•¡ í™˜ë¶ˆ

ì£¼ë¬¸ë²ˆí˜¸ì™€ í™˜ë¶ˆ ì‚¬ìœ ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.

ì˜ˆ)
ì£¼ë¬¸ë²ˆí˜¸: ORDER_20251004_XXXXX
ì‚¬ìœ : ê¸°ëŒ€ì™€ ë‹¬ë¼ì„œ
```

---

## ğŸ” ëª¨ë‹ˆí„°ë§ ë° ë””ë²„ê¹…

### 1. Google Sheets ëŒ€ì‹œë³´ë“œ

**ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§:**
```
Orders ì‹œíŠ¸ì—ì„œ í™•ì¸:
- ì´ ì£¼ë¬¸ ê±´ìˆ˜
- ì•Œë¦¼í†¡ ë°œì†¡ë¥  (alimtalkSent = true ë¹„ìœ¨)
- íœ´ëŒ€í° ë²ˆí˜¸ ìˆ˜ì§‘ë¥  (customerPhone ë¹„ìœ¨)
```

**ì¿¼ë¦¬ ì˜ˆì‹œ (Google Sheets í•¨ìˆ˜):**
```
// ì•Œë¦¼í†¡ ë°œì†¡ë¥ 
=COUNTIF(L:L, "true") / COUNTA(A:A) * 100

// íœ´ëŒ€í° ë²ˆí˜¸ ìˆ˜ì§‘ë¥ 
=COUNTIF(F:F, "<>") / COUNTA(A:A) * 100
```

### 2. Vercel Logs í™•ì¸

**ì•Œë¦¼í†¡ ë°œì†¡ ë¡œê·¸:**
```
# ì„±ê³µ ë¡œê·¸
âœ… ì•Œë¦¼í†¡ ë°œì†¡ ì„±ê³µ: {
  messageId: "SOLAPI_MSG_12345",
  to: "01012345678",
  orderId: "ORDER_XXXXX"
}

# ì‹¤íŒ¨ ë¡œê·¸
âŒ ì•Œë¦¼í†¡ ë°œì†¡ ì‹¤íŒ¨: {
  error: "ì”ì•¡ ë¶€ì¡±",
  to: "01012345678",
  orderId: "ORDER_XXXXX"
}
```

### 3. Solapi ëŒ€ì‹œë³´ë“œ

**í™•ì¸ í•­ëª©:**
- ë°œì†¡ ì„±ê³µë¥ 
- ì‹¤íŒ¨ ì›ì¸ ë¶„ì„
- ì”ì•¡ í™•ì¸
- í…œí”Œë¦¿ ìŠ¹ì¸ ìƒíƒœ

---

## âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ì œí•œì‚¬í•­

### 1. íœ´ëŒ€í° ë²ˆí˜¸ ìˆ˜ì§‘

**ë¬¸ì œ:** í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ ì‹œ íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ í•­ìƒ ë°›ëŠ” ê²ƒì€ ì•„ë‹˜

**í•´ê²° ë°©ì•ˆ:**
- **ì˜µì…˜ A:** ê²°ì œ ì „ ì…ë ¥ í¼ì—ì„œ íœ´ëŒ€í° ë²ˆí˜¸ ìˆ˜ì§‘
- **ì˜µì…˜ B:** ì´ë©”ì¼ë§Œìœ¼ë¡œë„ ì‹œìŠ¤í…œ ì‘ë™ (ì•Œë¦¼í†¡ì€ ì„ íƒì‚¬í•­)
- **í˜„ì¬ êµ¬í˜„:** íœ´ëŒ€í° ë²ˆí˜¸ ìˆìœ¼ë©´ ì•Œë¦¼í†¡ ë°œì†¡, ì—†ìœ¼ë©´ ì´ë©”ì¼ë§Œ

### 2. ì•Œë¦¼í†¡ ë¹„ìš©

**ì›”ë³„ ì˜ˆìƒ:**
- 100ê±´: 1,500ì›
- 1,000ê±´: 15,000ì›
- 10,000ê±´: 100,000ì› (ë‹¨ê°€ 10ì›)

**ì ˆê° ë°©ì•ˆ:**
- ì¤‘ìš” ì•Œë¦¼ë§Œ ì•Œë¦¼í†¡ ë°œì†¡
- ë‚˜ë¨¸ì§€ëŠ” ì´ë©”ì¼ë§Œ
- ë°œì†¡ëŸ‰ ì¦ê°€ ì‹œ ë”œëŸ¬ì‚¬ì™€ ë‹¨ê°€ í˜‘ìƒ

### 3. í…œí”Œë¦¿ ìŠ¹ì¸

**ì£¼ì˜ì‚¬í•­:**
- ê´‘ê³ ì„± ë¬¸êµ¬ ê¸ˆì§€
- ë³€ìˆ˜ ë§¤ì¹­ ì •í™•íˆ
- ìŠ¹ì¸ í›„ ìˆ˜ì • ì‹œ ì¬ìŠ¹ì¸ í•„ìš”

---

## ğŸ¯ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë°°í¬ ì „ í™•ì¸ì‚¬í•­

- [ ] Google Sheets ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸ (customerPhone í•„ë“œ ì¶”ê°€)
- [ ] í™˜ê²½ë³€ìˆ˜ ì„¤ì • (Solapi, ì¹´ì¹´ì˜¤ í…œí”Œë¦¿ ID)
- [ ] í…œí”Œë¦¿ 3ì¢… ìŠ¹ì¸ ì™„ë£Œ
- [ ] lib/sheets.js ìˆ˜ì • (íœ´ëŒ€í° ë²ˆí˜¸ í•„ë“œ)
- [ ] confirm-payment.js ìˆ˜ì • (ì•Œë¦¼í†¡ ì—°ë™)
- [ ] refund/process.js ìˆ˜ì • (ì•Œë¦¼í†¡ ì—°ë™)
- [ ] ì˜ì¡´ì„± ì„¤ì¹˜ (npm install solapi)
- [ ] í…ŒìŠ¤íŠ¸ ê²°ì œ ì§„í–‰
- [ ] ì´ë©”ì¼ + ì•Œë¦¼í†¡ ìˆ˜ì‹  í™•ì¸

### ìš´ì˜ ì‹œì‘ í›„

- [ ] ì¼ì¼ ì•Œë¦¼í†¡ ë°œì†¡ë¥  í™•ì¸
- [ ] ì£¼ê°„ ë¹„ìš© ëª¨ë‹ˆí„°ë§
- [ ] ì›”ê°„ ROI ë¶„ì„
- [ ] ê³ ê° í”¼ë“œë°± ìˆ˜ì§‘
- [ ] í…œí”Œë¦¿ ê°œì„ 

---

## ğŸš€ ë°°í¬ ìˆœì„œ

### 1ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸
```bash
# Google Sheets ì´ˆê¸°í™” (í—¤ë” ì—…ë°ì´íŠ¸)
npm run init-sheets
```

### 2ë‹¨ê³„: ì½”ë“œ ë°°í¬
```bash
git add .
git commit -m "ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼í†¡ ì‹œìŠ¤í…œ í†µí•©"
git push origin main
```

### 3ë‹¨ê³„: Vercel í™˜ê²½ë³€ìˆ˜ ì„¤ì •
- SOLAPI_API_KEY
- SOLAPI_API_SECRET
- KAKAO_PFID
- KAKAO_SENDER_KEY
- KAKAO_TEMPLATE_PAYMENT
- KAKAO_TEMPLATE_REFUND
- KAKAO_TEMPLATE_RENEWAL

### 4ë‹¨ê³„: ì¬ë°°í¬
- Vercel ìë™ ë°°í¬ ëŒ€ê¸°
- ë˜ëŠ” ìˆ˜ë™: `vercel --prod`

### 5ë‹¨ê³„: í…ŒìŠ¤íŠ¸
1. í…ŒìŠ¤íŠ¸ ê²°ì œ
2. ì´ë©”ì¼ + ì•Œë¦¼í†¡ í™•ì¸
3. Google Sheets ë°ì´í„° í™•ì¸

---

## ğŸ“Š í†µí•© íš¨ê³¼ ì˜ˆì¸¡

### Before (v2.0 ë‹¨ë…)
- ì´ë©”ì¼ë§Œ ë°œì†¡
- ì´ë©”ì¼ ë¯¸í™•ì¸ ì‹œ ê³ ê° ë¶ˆí¸
- ìˆ˜ë™ ë§í¬ ì¬ë°œê¸‰
- ê³ ê° ì‘ëŒ€ ì‹œê°„: ì›” 5ì‹œê°„

### After (v2.0 + ì¹´ì¹´ì˜¤í†¡)
- ì´ë©”ì¼ + ì•Œë¦¼í†¡ ë°œì†¡
- ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ì¦‰ì‹œ í™•ì¸
- ìë™ ë§í¬ ì¬ë°œê¸‰
- ê³ ê° ì‘ëŒ€ ì‹œê°„: ì›” 2.5ì‹œê°„

### ROI
- ë¹„ìš©: 1,500ì›/ì›” (100ê±´)
- ì ˆê°: 75,000ì›/ì›”
- **íˆ¬ì ëŒ€ë¹„ ìˆ˜ìµ: 5,000%**

---

**ì‘ì„±ì¼:** 2025ë…„ 10ì›” 4ì¼
**ë²„ì „:** v2.1 (í†µí•©)
**ë‹¤ìŒ ë‹¨ê³„:** ì‹¤ì œ ë°°í¬ ë° ìš´ì˜
